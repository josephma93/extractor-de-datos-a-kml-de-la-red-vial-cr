<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Generador unificado KML – Red Vial CR</title>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
  <style>
    :root {
      --font: Arial, system-ui, sans-serif;
      --clr-bg: #fafafa;
      --clr-card: #ffffff;
      --clr-primary: #2c3e50;
      --clr-accent: #007bff;
      --br: 6px;
    }

    body {
      margin: 0;
      padding: 1rem;
      font-family: var(--font);
      background: var(--clr-bg);
      color: var(--clr-primary);
      display: grid;
      gap: 1.5rem;
      grid-template-columns: 1fr;
    }

    h1 { margin: 0; font-size: 1.4rem; }

    .card {
      background: var(--clr-card);
      padding: 1rem;
      border-radius: var(--br);
      box-shadow: 0 2px 4px rgb(0 0 0 / .05);
      display: grid;
      gap: 1rem;
    }

    label { font-weight: 600; }

    input[type="number"], select {
      padding: .4rem .6rem;
      border: 1px solid #ccd;
      border-radius: var(--br);
      font-size: 1rem;
    }

    button {
      padding: .5rem 1rem;
      border: none;
      border-radius: var(--br);
      background: var(--clr-accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled{opacity:.6;cursor:not-allowed}

    #log {
      font-family: monospace;
      white-space: pre-wrap;
      background: #fff;
      border: 1px dashed #ccc;
      border-radius: var(--br);
      max-height: 260px;
      overflow-y: auto;
      padding: 1rem;
    }
    a.download-link{color:var(--clr-accent);font-weight:600;text-decoration:none}
  </style>
</head>
<body>
  <h1>Generador unificado de KML – Rutas nacionales y cantonales</h1>

  <!-- Selector tipo -->
  <div class="card">
    <label>
      <input type="radio" name="tipo" value="nacional" checked>
      Ruta Nacional (por número)
    </label>
    <label>
      <input type="radio" name="tipo" value="cantonal">
      Rutas Cantonales (por cantón)
    </label>
  </div>

  <!-- Formulario nacional -->
  <div class="card" id="form-nacional">
    <label for="route">Número de ruta nacional:</label>
    <input type="number" id="route" value="319" min="1" />
    <button id="btn-nacional">Generar KML</button>
  </div>

  <!-- Formulario cantonal -->
  <div class="card" id="form-cantonal" style="display:none">
    <label for="canton">Selecciona un cantón:</label>
    <select id="canton"></select>
    <button id="btn-cantonal" disabled>Generar KML</button>
  </div>

  <!-- Salida -->
  <div class="card">
    <a id="download" class="download-link" style="display:none"></a>
    <pre id="log"></pre>
  </div>

<script>
/**
 * @typedef {[number, number]} XY
 * @typedef {Object} SpatialReference
 * @property {number} wkid
 * @typedef {Object} Geometry
 * @property {XY[][]} paths
 * @property {SpatialReference} [spatialReference]
 * @typedef {Object} AttrNacional
 * @property {number} [RUTA]
 * @property {number|string} [SECCIÓN]
 * @property {number|string} [OBJECTID]
 * @typedef {Object} AttrCantonal
 * @property {string} [Canton_1]
 * @property {string|number} [Cod_camino_1]
 * @property {string|number} [Seccion]
 * @property {string} [Validado]
 * @property {number|string} [OBJECTID]
 * @typedef {Object} Feature
 * @property {Geometry} geometry
 * @property {AttrNacional|AttrCantonal|Object} attributes
 * @typedef {Object} QueryResponse
 * @property {string} objectIdFieldName
 * @property {string} geometryType
 * @property {SpatialReference} spatialReference
 * @property {Feature[]} features
 * @typedef {Object} LogEntry
 * @property {number} ts
 * @property {string} event
 * @property {any} [detail]
 * @typedef {Object} PathItem
 * @property {string} name
 * @property {XY[]} crtm
 * @property {XY[]} wgs
 * @property {XY} start
 * @property {XY} end
 * @property {XY} center
 * @property {number} len
 */

const logBox = document.getElementById('log');
const log = (event, detail = {}) => {
  /** @type {LogEntry} */
  const entry = { ts: Date.now(), event, ...detail };
  logBox.textContent += JSON.stringify(entry) + "\n";
};

proj4.defs('EPSG:5367', '+proj=tmerc +lat_0=0 +lon_0=-84 +k=0.9999 +x_0=500000 +y_0=0 +ellps=WGS84 +units=m +no_defs');
proj4.defs('EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs');

/**
 * @param {XY} xy
 * @returns {XY}
 */
const toWGS = (xy) => proj4('EPSG:5367', 'EPSG:4326', xy);

/**
 * @param {XY[]} pts
 * @returns {XY[]}
 */
const collapse = (pts) =>
  pts.filter((p, i, a) => i === 0 || p[0] !== a[i - 1][0] || p[1] !== a[i - 1][1]);

/**
 * @param {XY[]} pts
 * @returns {number}
 */
const lengthCRTM = (pts) => {
  let d = 0;
  for (let i = 1; i < pts.length; i++) {
    const dx = pts[i][0] - pts[i - 1][0];
    const dy = pts[i][1] - pts[i - 1][1];
    d += Math.hypot(dx, dy);
  }
  return d;
};

/**
 * @param {XY[]} pts
 * @returns {XY}
 */
const centroid = (pts) => {
  let sx = 0, sy = 0;
  for (const [x, y] of pts) { sx += x; sy += y; }
  const n = pts.length || 1;
  return [sx / n, sy / n];
};

/**
 * @param {XY} a
 * @param {XY} b
 * @returns {number}
 */
const dist = (a, b) => Math.hypot(a[0] - b[0], a[1] - b[1]);

document.querySelectorAll('input[name="tipo"]').forEach((r) =>
  r.addEventListener('change', (e) => {
    const val = /** @type {HTMLInputElement} */ (e.target).value;
    document.getElementById('form-nacional').style.display = val === 'nacional' ? 'grid' : 'none';
    document.getElementById('form-cantonal').style.display = val === 'cantonal' ? 'grid' : 'none';
    log('uiSwitch', { tipo: val });
  })
);

fetch(
  'https://services8.arcgis.com/gEjMfQjIBmRHMGao/arcgis/rest/services/RVC_Version_final/FeatureServer/0/query?' +
    new URLSearchParams({
      where: '1=1',
      outFields: 'Canton_1',
      returnDistinctValues: 'true',
      returnGeometry: 'false',
      f: 'json'
    })
)
  .then((r) => r.json())
  .then(
    /** @param {QueryResponse} j */ (j) => {
      const sel = /** @type {HTMLSelectElement} */ (document.getElementById('canton'));
      [...new Set(j.features.map((f) => (f.attributes || {}).Canton_1))].sort().forEach((c) => {
        const o = document.createElement('option');
        o.value = String(c);
        o.textContent = String(c);
        sel.appendChild(o);
      });
      document.getElementById('btn-cantonal').disabled = false;
      log('loadCantones', { total: sel.length });
    }
  )
  .catch((e) => log('error', { message: e.message }));

const btnNac = document.getElementById('btn-nacional');
btnNac.addEventListener('click', () => {
  const ruta = /** @type {HTMLInputElement} */ (document.getElementById('route')).value;
  const params = new URLSearchParams({
    where: `RUTA = ${ruta}`,
    outFields: '*',
    returnGeometry: 'true',
    f: 'json'
  });
  const url =
    `https://services8.arcgis.com/gEjMfQjIBmRHMGao/arcgis/rest/services/Red_Vial_Nacional_Proyecto/FeatureServer/0/query?` +
    params.toString();
  log('apiCall', { tipo: 'nacional', url });
  fetch(url)
    .then((r) => r.json())
    .then(
      /** @param {QueryResponse} data */ (data) =>
        buildKMLFromFeatures(data.features, `Ruta nacional ${ruta}`)
    )
    .catch((e) => log('error', { message: e.message }));
});

const btnCant = document.getElementById('btn-cantonal');
btnCant.addEventListener('click', () => {
  const canton = /** @type {HTMLSelectElement} */ (document.getElementById('canton')).value;
  const params = new URLSearchParams({
    where: `Canton_1='${canton}'`,
    outFields: '*',
    returnGeometry: 'true',
    f: 'json'
  });
  const url =
    `https://services8.arcgis.com/gEjMfQjIBmRHMGao/arcgis/rest/services/RVC_Version_final/FeatureServer/0/query?` +
    params.toString();
  log('apiCall', { tipo: 'cantonal', url });
  fetch(url)
    .then((r) => r.json())
    .then(
      /** @param {QueryResponse} d */ (d) =>
        buildKMLFromFeatures(d.features, `Rutas cantonales ${canton}`)
    )
    .catch((e) => log('error', { message: e.message }));
});

/**
 * @param {Feature[]|undefined} feats
 * @param {string} label
 * @returns {void}
 */
function buildKMLFromFeatures(feats, label) {
  if (!feats || feats.length === 0) {
    log('response', { total: 0 });
    return;
  }
  log('response', { total: feats.length });
  /** @type {PathItem[]} */
  const items = [];
  feats.forEach((f, i) => {
    const a = f.attributes || {};
    const baseName =
      /** @type {AttrCantonal} */ (a).Cod_camino_1 ||
      /** @type {AttrNacional} */ (a).RUTA ||
      `Feature_${i}`;
    (f.geometry.paths || []).forEach((path, pi) => {
      const crtm = collapse(path);
      if (crtm.length < 2) {
        log('discardedPath', { i, pi });
        return;
      }
      const wgs = crtm.map(toWGS);
      const start = crtm[0];
      const end = crtm[crtm.length - 1];
      const center = centroid(crtm);
      const len = lengthCRTM(crtm);
      items.push({ name: String(baseName), crtm, wgs, start, end, center, len });
    });
  });

  if (items.length === 0) {
    log('noPaths', {});
    return;
  }

  const ordered = orderByProximity(items);
  const kml = [
    '<?xml version="1.0" encoding="UTF-8"?>',
    '<kml xmlns="http://www.opengis.net/kml/2.2"><Document>'
  ];
  for (const it of ordered) {
    kml.push(
      `<Placemark><name>${it.name}</name><LineString><tessellate>1</tessellate><coordinates>` +
        it.wgs.map(([lo, la]) => `${lo.toFixed(6)},${la.toFixed(6)},0`).join(' ') +
        `</coordinates></LineString></Placemark>`
    );
  }
  kml.push('</Document></kml>');

  const blob = new Blob(kml, { type: 'application/vnd.google-earth.kml+xml' });
  const link = /** @type {HTMLAnchorElement} */ (document.getElementById('download'));
  link.href = URL.createObjectURL(blob);
  link.download = `${label}.kml`;
  link.textContent = `Descargar ${label}.kml`;
  link.style.display = 'inline-block';
  log('kmlWrite', { bytes: blob.size, paths: ordered.length });
}

/**
 * @param {PathItem[]} items
 * @returns {PathItem[]}
 */
function orderByProximity(items) {
  const remaining = items.slice().sort((a, b) =>
    a.center[0] === b.center[0] ? a.center[1] - b.center[1] : a.center[0] - b.center[0]
  );
  /** @type {PathItem[]} */
  const result = [];
  let current = remaining.shift();
  if (!current) return result;
  result.push(current);
  let cursor = current.end;

  while (remaining.length) {
    let bestIdx = -1;
    let bestRev = false;
    let bestD = Infinity;
    for (let i = 0; i < remaining.length; i++) {
      const it = remaining[i];
      const dStart = dist(cursor, it.start);
      const dEnd = dist(cursor, it.end);
      if (dStart < bestD) { bestD = dStart; bestIdx = i; bestRev = false; }
      if (dEnd < bestD) { bestD = dEnd; bestIdx = i; bestRev = true; }
    }
    const next = /** @type {PathItem} */ (remaining.splice(bestIdx, 1)[0]);
    if (bestRev) {
      next.crtm.reverse();
      next.wgs.reverse();
      const tmp = next.start;
      next.start = next.end;
      next.end = tmp;
    }
    result.push(next);
    cursor = next.end;
  }
  return result;
}
</script>
</body>
</html>
